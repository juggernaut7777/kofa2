name: Deploy KOFA Backend to Azure VM

on:
  push:
    branches: [ main ]
    paths:
      - 'chatbot/**'
      - 'requirements.txt'
      - 'init_mysql.py'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Azure VM via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 134.112.17.54
          username: azureuser
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Starting deployment..."
            cd ~/kofa2
            
            # Pull latest changes
            echo "üì• Pulling latest code..."
            git pull origin main
            
            # Install dependencies
            echo "üì¶ Installing dependencies..."
            pip install -r requirements.txt --upgrade
            
            # Set environment variables for MySQL (FREE tier)
            export DB_TYPE=mysql
            export MYSQL_HOST=kofa-mysql.mysql.database.azure.com
            export MYSQL_USER=azureuser
            export MYSQL_PASSWORD='Chiwendu619$$$'
            export MYSQL_DATABASE=kofa
            export GROQ_API_KEY='${{ secrets.GROQ_API_KEY }}'
            
            # Restart backend service (or start with uvicorn)
            echo "üîÑ Restarting backend..."
            pkill -f uvicorn || true
            nohup uvicorn chatbot.main:app --host 0.0.0.0 --port 8000 > ~/kofa.log 2>&1 &
            
            # Wait and verify
            sleep 5
            if curl -s http://localhost:8000/ > /dev/null; then
              echo "‚úÖ Deployment successful!"
            else
              echo "‚ö†Ô∏è Checking if server started..."
              cat ~/kofa.log | tail -20
            fi
            
      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ KOFA Backend deployed successfully to Azure VM"
          else
            echo "‚ùå Deployment failed"
          fi
